<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>TRPG 实时协作工作台 - v1.3.10 Static Nav & Embedded Button</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.1, maximum-scale=5.0">
    <style>
        /* --- 1. 基础全局样式 --- */
        body {
            margin: 0;
            background: #f4f7f9;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Microsoft YaHei", sans-serif;
            color: #333;
            overflow-x: auto;
            -webkit-text-size-adjust: 100%;
        }

        :root {
            --grid-layout: repeat(3, minmax(280px, 1fr)) 50px;
            --row-even-bg: #ffffff;
            --row-odd-bg: #edf0f3;
            --border-color: #d1d9e0;
        }

        /* --- 2. 顶部导航栏 (修改：不再悬浮) --- */
        .top-nav {
            display: grid;
            grid-template-columns: var(--grid-layout);
            column-gap: 20px;
            background: #212529;
            color: white;
            /* 修改点：删除了 position: sticky; top: 0; */
            /* 现在它只是普通的一行，会随页面滚动而移出视野 */
            position: relative;
            z-index: 100;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            align-items: center;
            width: max-content;
            min-width: 100%;
            box-sizing: border-box;
            height: 60px;
        }

        .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .column-title-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid transparent;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            padding: 8px 12px;
            border-radius: 4px;
            outline: none;
            text-align: center;
            letter-spacing: 1px;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        /* --- 3. 省略号菜单 --- */
        .menu-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .ellipsis-btn {
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 6px;
            width: 160px;
            z-index: 200;
            padding: 5px 0;
        }

            .dropdown-menu button {
                width: 100%;
                padding: 10px 15px;
                border: none;
                background: none;
                color: #444;
                font-size: 13px;
                cursor: pointer;
                text-align: left;
            }

                .dropdown-menu button:hover {
                    background: #f8f9fa;
                }

        /* --- 4. 核心布局网格 --- */
        .main-workspace {
            display: grid;
            grid-template-columns: var(--grid-layout);
            column-gap: 20px;
            padding: 20px;
            align-items: stretch;
            width: max-content;
            min-width: 100%;
            box-sizing: border-box;
        }

        /* --- 5. 打字小格子样式 --- */
        .box-wrapper {
            padding: 22px 18px;
            position: relative;
            border: 1px solid var(--border-color);
            margin-bottom: -1px;
            display: flex;
            flex-direction: column;
        }

        .row-even {
            background-color: var(--row-even-bg);
        }

        .row-odd {
            background-color: var(--row-odd-bg);
        }

        textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.8;
            letter-spacing: 0.5px;
            background: transparent;
            overflow: hidden;
            color: #2c3e50;
            font-family: inherit;
        }

        /* --- 6. 右侧窄版身份标签 --- */
        .row-label {
            grid-column-end: -1;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            letter-spacing: 4px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            border-left: none;
            margin-bottom: -1px;
            user-select: none;
        }

        .label-keeper {
            color: #546e7a;
            background-color: var(--row-odd-bg);
        }

        .label-investigator {
            color: #90a4ae;
            background-color: var(--row-even-bg);
        }

        /* --- 7. 底部全局控制按钮 (嵌入表格版) --- */
        /* 这个容器现在是 grid 的一个子元素 */
        .global-row-controls {
            /* 核心修改：让它跨越所有列（从第一列到最后一列） */
            grid-column: 1 / -1;
            width: 100%; /* 占满 Grid 给它的空间 */
            padding: 30px 0 100px 0;
            display: flex;
            justify-content: center;
        }

        .add-row-btn {
            width: 100%; /* 撑满这一行 */
            height: 60px;
            background: #ffffff;
            border: 2px dashed #d1d9e0;
            border-radius: 8px;
            color: #78909c;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .add-row-btn:hover {
                border-color: #212529;
                color: #212529;
                background: #f8f9fa;
                box-shadow: 0 4px 8px rgba(0,0,0,0.05);
                transform: translateY(-2px);
            }

            .add-row-btn:active {
                transform: translateY(0);
            }

        @media (max-width: 768px) {
            textarea {
                letter-spacing: 0.1px;
            }

            .column-title-input {
                letter-spacing: 0px;
            }
        }
    </style>
</head>
<body onclick="closeMenu(event)">

    <div class="top-nav">
        <div class="menu-container">
            <button class="ellipsis-btn" onclick="toggleMenu(event)">&#8942;</button>
            <div class="dropdown-menu" id="moreMenu">
                <button onclick="askAddColumn()" style="color: #2ecc71;">+ 新增一列</button>
                <button onclick="askRemoveColumn()" style="color: #e67e22;">- 删减最后一列</button>
            </div>
        </div>
    </div>

    <div class="main-workspace" id="main-grid">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/workspaceHub")
            .withAutomaticReconnect()
            .build();

        let currentColumns = [];
        let columnCounts = {};
        let renderedRows = new Set();

        function toggleMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('moreMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function closeMenu(e) {
            document.getElementById('moreMenu').style.display = 'none';
        }

        connection.on("LoadWorkspace", (columns, boxes) => {
            currentColumns = columns;
            const grid = document.getElementById("main-grid");
            const nav = document.querySelector('.top-nav');
            const menuContainer = document.querySelector('.menu-container');

            grid.innerHTML = "";
            columnCounts = {};
            renderedRows.clear();

            // 布局：280px 宽列
            document.documentElement.style.setProperty('--grid-layout', `repeat(${columns.length}, minmax(280px, 1fr)) 50px`);

            // 导航栏处理
            nav.querySelectorAll('.nav-item').forEach(el => el.remove());
            columns.forEach(col => {
                columnCounts[col.id] = 0;
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.innerHTML = `<input type="text" class="column-title-input" id="title-${col.id}" value="${col.title}" oninput="onTitleChange('${col.id}')">`;
                nav.insertBefore(item, menuContainer);
            });

            // 渲染格子
            boxes.forEach(b => {
                const colIndex = columns.findIndex(c => c.id === b.columnId) + 1;
                if (colIndex > 0) renderBox(b.columnId, b.id, b.content, colIndex);
            });

            // --- 核心修改：加载完格子后，把大按钮作为 Grid 的最后一个元素加上去 ---
            renderGlobalButton();
        });

        function renderGlobalButton() {
            const grid = document.getElementById("main-grid");

            // 创建按钮容器
            const container = document.createElement("div");
            container.className = "global-row-controls";

            // 创建按钮
            const btn = document.createElement("button");
            btn.className = "add-row-btn";
            btn.onclick = askAddRow;
            btn.innerHTML = "<span>+</span> 批量添加 10 行剧情 (同步所有列)";

            container.appendChild(btn);
            grid.appendChild(container);
        }

        function renderBox(columnId, boxId, content, colIndex) {
            const grid = document.getElementById("main-grid");
            columnCounts[columnId]++;
            const rowIndex = columnCounts[columnId];

            updateRowLabel(rowIndex);

            const wrapper = document.createElement("div");
            wrapper.className = `box-wrapper ${rowIndex % 2 !== 0 ? 'row-odd' : 'row-even'}`;
            wrapper.style.gridColumn = colIndex;
            wrapper.style.gridRow = rowIndex;

            const textarea = document.createElement("textarea");
            textarea.id = boxId;
            textarea.value = content;
            textarea.placeholder = "...";
            textarea.oninput = function () { autoResize(this); onTyping(boxId); };

            wrapper.appendChild(textarea);
            grid.appendChild(wrapper);

            autoResize(textarea);
        }

        function updateRowLabel(rowIndex) {
            if (renderedRows.has(rowIndex)) return;

            const labelId = "label-row-" + rowIndex;
            const label = document.createElement("div");
            label.id = labelId;
            const isKeeper = rowIndex % 2 !== 0;
            label.className = `row-label ${isKeeper ? 'label-keeper' : 'label-investigator'}`;
            label.innerText = isKeeper ? "守秘人" : "调查员";
            label.style.gridRow = rowIndex;
            document.getElementById("main-grid").appendChild(label);

            renderedRows.add(rowIndex);
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function askAddColumn() { connection.invoke("AddColumn"); }
        function askRemoveColumn() { if (confirm("确定删除最后一列吗？")) connection.invoke("RemoveLastColumn"); }
        function askAddRow() { connection.invoke("RequestAddRow").catch(err => console.error(err)); }

        function onTyping(boxId) {
            const val = document.getElementById(boxId).value;
            connection.invoke("SendTextUpdate", boxId, val);
        }

        function onTitleChange(columnId) {
            const val = document.getElementById("title-" + columnId).value;
            connection.invoke("UpdateColumnTitle", columnId, val);
        }

        connection.on("OnLayoutUpdated", () => location.reload());
        connection.on("OnTextUpdated", (boxId, content) => {
            const el = document.getElementById(boxId);
            if (el) { el.value = content; autoResize(el); }
        });
        connection.on("OnTitleUpdated", (columnId, newTitle) => {
            const input = document.getElementById("title-" + columnId);
            if (input) input.value = newTitle;
        });

        connection.start().catch(err => console.error(err));
    </script>
</body>
</html>