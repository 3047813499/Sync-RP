<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>TRPG 实时协作工作台 - v1.2.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.1, maximum-scale=5.0">
    <style>
        /* --- 1. 基础全局样式 --- */
        body { 
            margin: 0; 
            background: #f4f7f9; 
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Microsoft YaHei", sans-serif; 
            color: #333;
            min-width: 1000px; 
            overflow-x: auto;
            -webkit-text-size-adjust: 100%;
        }

        :root {
            /* 这里的 repeat(3, 1fr) 会在 JS 中被动态修改 */
            --grid-layout: repeat(3, 1fr) 50px;
            --row-even-bg: #ffffff; 
            --row-odd-bg: #edf0f3;  
            --border-color: #d1d9e0; 
        }

        /* --- 2. 顶部导航栏 --- */
        .top-nav { 
            display: grid; 
            grid-template-columns: var(--grid-layout);
            background: #212529; 
            color: white; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            padding: 0 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            align-items: center;
        }
        .nav-item { 
            padding: 12px 0; 
            display: flex;
            justify-content: center;
            padding-right: 20px;
        }
        .column-title-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid transparent;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            width: 85%;
            padding: 8px 12px;
            border-radius: 4px;
            outline: none;
            text-align: center;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        /* --- 3. 省略号菜单 --- */
        .menu-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ellipsis-btn {
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 6px;
            width: 160px;
            z-index: 200;
            padding: 5px 0;
        }
        .dropdown-menu button {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            color: #444;
            font-size: 13px;
            cursor: pointer;
            text-align: left;
        }
        .dropdown-menu button:hover { background: #f8f9fa; }
        .dropdown-menu .danger-btn { color: #e74c3c; font-weight: bold; }

        /* --- 4. 核心布局网格 --- */
        .main-workspace {
            display: grid;
            grid-template-columns: var(--grid-layout);
            column-gap: 20px; 
            padding: 20px;
            align-items: stretch;
        }

        /* --- 5. 打字小格子样式 --- */
        .box-wrapper {
            padding: 22px 18px;
            position: relative;
            border: 1px solid var(--border-color);
            margin-bottom: -1px; 
            display: flex;
            flex-direction: column;
        }
        .row-even { background-color: var(--row-even-bg); }
        .row-odd  { background-color: var(--row-odd-bg); }

        textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 15px;
            line-height: 1.8;
            letter-spacing: 0.5px;
            background: transparent;
            overflow: hidden;
            color: #2c3e50;
            font-family: inherit;
        }

        /* --- 6. 右侧窄版身份标签 --- */
        .row-label {
            grid-column-end: -1; /* 始终位于最后一列 */
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            letter-spacing: 4px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            border-left: none;
            margin-bottom: -1px;
            user-select: none;
        }
        .label-keeper { color: #546e7a; background-color: var(--row-odd-bg); }
        .label-investigator { color: #90a4ae; background-color: var(--row-even-bg); }

        /* --- 7. 辅助功能 --- */
        .add-box-trigger {
            background: rgba(0,0,0,0.04);
            border: 2px dashed #b0bec5;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: #78909c;
            font-size: 20px;
            margin-top: 10px;
        }
        .del-btn {
            position: absolute; right: 5px; top: 2px;
            background: none; border: none; color: #cfd8dc;
            cursor: pointer; font-size: 18px; opacity: 0;
        }
        .box-wrapper:hover .del-btn { opacity: 1; }

        @media (max-width: 768px) {
            textarea { letter-spacing: 0.1px; }
            .column-title-input { letter-spacing: 0px; }
            .del-btn { opacity: 0.5; }
        }
    </style>
</head>
<body onclick="closeMenu(event)">

    <div class="top-nav">
        <div class="menu-container">
            <button class="ellipsis-btn" onclick="toggleMenu(event)">&#8942;</button>
            <div class="dropdown-menu" id="moreMenu">
                <button onclick="askAddColumn()" style="color: #2ecc71;">+ 新增一列</button>
                <button onclick="askRemoveColumn()" style="color: #e67e22;">- 删减最后一列</button>
                <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
                <button class="danger-btn" onclick="askClearAll()">清空全部数据</button>
            </div>
        </div>
    </div>

    <div class="main-workspace" id="main-grid"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/workspaceHub")
            .withAutomaticReconnect()
            .build();

        let currentColumns = []; 
        let columnCounts = {};

        function toggleMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('moreMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function closeMenu(e) {
            document.getElementById('moreMenu').style.display = 'none';
        }

        // --- 核心：加载整个布局 ---
        connection.on("LoadWorkspace", (columns, boxes) => {
            currentColumns = columns;
            const grid = document.getElementById("main-grid");
            const nav = document.querySelector('.top-nav');
            const menuContainer = document.querySelector('.menu-container');

            grid.innerHTML = "";
            columnCounts = {};
            
            // 动态设置 CSS 变量
            document.documentElement.style.setProperty('--grid-layout', `repeat(${columns.length}, 1fr) 50px`);

            // 动态生成标题输入框
            nav.querySelectorAll('.nav-item').forEach(el => el.remove());
            columns.forEach(col => {
                columnCounts[col.id] = 0;
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.innerHTML = `<input type="text" class="column-title-input" id="title-${col.id}" value="${col.title}" oninput="onTitleChange('${col.id}')">`;
                nav.insertBefore(item, menuContainer);
            });

            // 渲染格子
            boxes.sort((a,b) => a.id.localeCompare(b.id)).forEach(b => {
                const colIndex = columns.findIndex(c => c.id === b.columnId) + 1;
                if (colIndex > 0) renderBox(b.columnId, b.id, b.content, colIndex);
            });

            // 初始化加号
            columns.forEach((col, index) => {
                updateAddTrigger(col.id, index + 1, columnCounts[col.id] + 1);
            });
        });

        function renderBox(columnId, boxId, content, colIndex) {
            const grid = document.getElementById("main-grid");
            columnCounts[columnId]++;
            const rowIndex = columnCounts[columnId];

            updateRowLabel(rowIndex);

            const wrapper = document.createElement("div");
            wrapper.className = `box-wrapper ${rowIndex % 2 !== 0 ? 'row-odd' : 'row-even'}`;
            wrapper.style.gridColumn = colIndex;
            wrapper.style.gridRow = rowIndex;

            const delBtn = document.createElement("button");
            delBtn.className = "del-btn";
            delBtn.innerHTML = "&times;";
            delBtn.onclick = () => { if(confirm("确定删除这个格子？")) connection.invoke("RequestDeleteBox", boxId); };

            const textarea = document.createElement("textarea");
            textarea.id = boxId;
            textarea.value = content;
            textarea.placeholder = "...";
            textarea.oninput = function() { autoResize(this); onTyping(boxId); };

            wrapper.appendChild(delBtn);
            wrapper.appendChild(textarea);
            grid.appendChild(wrapper);

            updateAddTrigger(columnId, colIndex, rowIndex + 1);
            setTimeout(() => autoResize(textarea), 50);
        }

        function updateRowLabel(rowIndex) {
            const labelId = "label-row-" + rowIndex;
            let label = document.getElementById(labelId);
            if (!label) {
                label = document.createElement("div");
                label.id = labelId;
                const isKeeper = rowIndex % 2 !== 0;
                label.className = `row-label ${isKeeper ? 'label-keeper' : 'label-investigator'}`;
                label.innerText = isKeeper ? "守秘人" : "调查员";
                label.style.gridRow = rowIndex;
                document.getElementById("main-grid").appendChild(label);
            }
        }

        function updateAddTrigger(columnId, colIndex, nextRow) {
            let trigger = document.getElementById("trigger-" + columnId);
            if (!trigger) {
                trigger = document.createElement("div");
                trigger.id = "trigger-" + columnId;
                trigger.className = "add-box-trigger";
                trigger.innerText = "+";
                trigger.onclick = () => askAddBox(columnId);
                document.getElementById("main-grid").appendChild(trigger);
            }
            trigger.style.gridColumn = colIndex;
            trigger.style.gridRow = nextRow;
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // --- 指令发送 ---
        function askAddColumn() { connection.invoke("AddColumn"); }
        function askRemoveColumn() { if(confirm("确定删除最后一列吗？")) connection.invoke("RemoveLastColumn"); }
        function askAddBox(columnId) { const id = "box_" + Date.now(); connection.invoke("RequestAddBox", columnId, id); }
        function onTyping(boxId) { const val = document.getElementById(boxId).value; connection.invoke("SendTextUpdate", boxId, val); }
        function onTitleChange(columnId) { const val = document.getElementById("title-" + columnId).value; connection.invoke("UpdateColumnTitle", columnId, val); }
        function askClearAll() { if (confirm("确定清空全部数据？")) connection.invoke("ClearAllBoxes"); }

        // --- 信号监听 ---
        connection.on("OnLayoutUpdated", () => location.reload());
        connection.on("OnTextUpdated", (boxId, content) => {
            const el = document.getElementById(boxId);
            if (el) { el.value = content; autoResize(el); }
        });
        connection.on("OnTitleUpdated", (columnId, newTitle) => {
            const input = document.getElementById("title-" + columnId);
            if (input) input.value = newTitle;
        });

        connection.start().catch(err => console.error(err));
    </script>
</body>
</html>