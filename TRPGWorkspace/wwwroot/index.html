<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>TRPG å®æ—¶åä½œå·¥ä½œå° - v1.4.2 Script Logic Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.1, maximum-scale=5.0">
    <style>
        /* --- 1. åŸºç¡€å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            background: #f4f7f9;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Microsoft YaHei", sans-serif;
            color: #333;
            overflow-x: auto;
            -webkit-text-size-adjust: 100%;
        }

        :root {
            --grid-layout: repeat(3, minmax(280px, 1fr)) 50px;
            --row-even-bg: #ffffff;
            --row-odd-bg: #edf0f3;
            --border-color: #d1d9e0;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ  --- */
        .top-nav {
            display: grid;
            grid-template-columns: var(--grid-layout);
            column-gap: 20px;
            background: #212529;
            color: white;
            position: relative;
            z-index: 100;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            align-items: center;
            width: max-content;
            min-width: 100%;
            box-sizing: border-box;
            height: 60px;
        }

        .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .column-title-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid transparent;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            padding: 8px 12px;
            border-radius: 4px;
            outline: none;
            text-align: center;
            letter-spacing: 1px;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        /* --- 3. çœç•¥å·èœå• --- */
        .menu-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .ellipsis-btn {
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 6px;
            width: 180px;
            z-index: 200;
            padding: 5px 0;
            text-align: left;
        }

            .dropdown-menu button {
                width: 100%;
                padding: 12px 15px;
                border: none;
                background: none;
                color: #444;
                font-size: 14px;
                cursor: pointer;
                text-align: left;
                display: flex;
                align-items: center;
                gap: 10px;
            }

                .dropdown-menu button:hover {
                    background: #f8f9fa;
                }

        /* --- 4. æ ¸å¿ƒå¸ƒå±€ç½‘æ ¼ --- */
        .main-workspace {
            display: grid;
            grid-template-columns: var(--grid-layout);
            column-gap: 20px;
            padding: 20px;
            align-items: stretch;
            width: max-content;
            min-width: 100%;
            box-sizing: border-box;
        }

        /* --- 5. æ‰“å­—å°æ ¼å­æ ·å¼ --- */
        .box-wrapper {
            padding: 22px 18px;
            position: relative;
            border: 1px solid var(--border-color);
            margin-bottom: -1px;
            display: flex;
            flex-direction: column;
        }

        .row-even {
            background-color: var(--row-even-bg);
        }

        .row-odd {
            background-color: var(--row-odd-bg);
        }

        textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.8;
            letter-spacing: 0.5px;
            background: transparent;
            overflow: hidden;
            color: #2c3e50;
            font-family: inherit;
        }

        /* --- 6. å³ä¾§çª„ç‰ˆèº«ä»½æ ‡ç­¾ --- */
        .row-label {
            grid-column-end: -1;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            letter-spacing: 4px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            border-left: none;
            margin-bottom: -1px;
            user-select: none;
        }

        .label-keeper {
            color: #546e7a;
            background-color: var(--row-odd-bg);
        }

        .label-investigator {
            color: #90a4ae;
            background-color: var(--row-even-bg);
        }

        /* --- 7. åº•éƒ¨å…¨å±€æ§åˆ¶æŒ‰é’® (åµŒå…¥è¡¨æ ¼ç‰ˆ) --- */
        .global-row-controls {
            grid-column: 1 / -1;
            width: 100%;
            padding: 30px 0 100px 0;
            display: flex;
            justify-content: center;
        }

        .add-row-btn {
            width: 100%;
            height: 60px;
            background: #ffffff;
            border: 2px dashed #d1d9e0;
            border-radius: 8px;
            color: #78909c;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .add-row-btn:hover {
                border-color: #212529;
                color: #212529;
                background: #f8f9fa;
                box-shadow: 0 4px 8px rgba(0,0,0,0.05);
                transform: translateY(-2px);
            }

            .add-row-btn:active {
                transform: translateY(0);
            }

        @media (max-width: 768px) {
            textarea {
                letter-spacing: 0.1px;
            }

            .column-title-input {
                letter-spacing: 0px;
            }
        }
    </style>
</head>
<body onclick="closeMenu(event)">

    <div class="top-nav">
        <div class="menu-container">
            <button class="ellipsis-btn" onclick="toggleMenu(event)">&#8942;</button>
            <div class="dropdown-menu" id="moreMenu">
                <button onclick="askAddColumn()" style="color: #2ecc71;">â• æ–°å¢ä¸€åˆ—</button>
                <button onclick="askRemoveColumn()" style="color: #e67e22;">â– åˆ å‡æœ€åä¸€åˆ—</button>
                <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">

                <button onclick="exportImage()" style="color: #3498db;">ğŸ“¸ å¯¼å‡ºä¸ºå›¾ç‰‡ (é•¿æˆªå›¾)</button>
                <button onclick="exportTxt()" style="color: #9b59b6;">ğŸ“ å¯¼å‡ºä¸ºå‰§æœ¬ (.txt)</button>
                <button onclick="exportJson()" style="color: #34495e;">ğŸ’¾ å¯¼å‡ºä¸ºå¤‡ä»½ (.json)</button>
            </div>
        </div>
    </div>

    <div class="main-workspace" id="main-grid">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // --- 1. å¯¼å‡ºå›¾ç‰‡é€»è¾‘ ---
        function exportImage() {
            closeMenu();
            const btn = document.querySelector('.ellipsis-btn');
            const originalText = btn.innerText;
            btn.innerText = 'â³';

            // 1. åœ¨æˆªå›¾å‰ï¼Œå…ˆè·å–åŸé¡µé¢æ‰€æœ‰ textarea çš„â€œçœŸå®å€¼â€å’Œâ€œçœŸå®å®½åº¦â€
            // å› ä¸º html2canvas çš„å…‹éš†è¿‡ç¨‹æœ‰æ—¶ä¼šä¸¢å¤±ç”¨æˆ·åˆšåˆšæ‰“çš„å­—
            const originalTextareas = Array.from(document.querySelectorAll('textarea'));
            const stateMap = originalTextareas.map(t => ({
                value: t.value,
                width: t.getBoundingClientRect().width, // è·å–ç²¾ç¡®åƒç´ å®½åº¦
                computedStyle: window.getComputedStyle(t) // è·å–ç²¾ç¡®æ ·å¼
            }));

            // è·å–æ•´ä¸ªé¡µé¢çš„å°ºå¯¸
            const fullHeight = document.body.scrollHeight;
            const fullWidth = document.body.scrollWidth;

            html2canvas(document.body, {
                // å…³é”®ï¼šåœ¨å…‹éš†é˜¶æ®µè¿›è¡Œæ‰‹æœ¯
                onclone: (clonedDoc) => {
                    // æ‰¾åˆ°å…‹éš†é¡µé¢é‡Œçš„æ‰€æœ‰ textarea
                    const clonedTextareas = Array.from(clonedDoc.querySelectorAll('textarea'));

                    // éå†æ¯ä¸€ä¸ªå…‹éš†çš„è¾“å…¥æ¡†
                    clonedTextareas.forEach((clonedTextarea, index) => {
                        const state = stateMap[index]; // æ‰¾åˆ°å®ƒåœ¨åŸé¡µé¢çš„â€œçœŸèº«â€æ•°æ®

                        // åˆ›å»ºä¸€ä¸ª div æ¥æ›¿èº«
                        const div = clonedDoc.createElement('div');

                        // 1. å¼ºåˆ¶é”æ­»å®½åº¦ï¼šç¦æ­¢æ¨ªå‘æ‹‰é•¿ï¼
                        // ä½¿ç”¨åŸé¡µé¢æµ‹é‡å‡ºçš„åƒç´ å€¼
                        div.style.width = state.width + 'px';

                        // 2. å¼ºåˆ¶æ¢è¡Œæ ·å¼çš„æ ¸å¿ƒç»„åˆ
                        div.style.whiteSpace = 'pre-wrap';   // ä¿ç•™å›è½¦ï¼Œè‡ªåŠ¨æ¢è¡Œ
                        div.style.wordBreak = 'break-word';  // é˜²æ­¢é•¿å•è¯æ’‘ç ´å¸ƒå±€
                        div.style.overflow = 'hidden';       // é˜²æ­¢æº¢å‡º

                        // 3. å¤åˆ¶å­—ä½“æ ·å¼ï¼Œä¿è¯é•¿å¾—ä¸€æ ·
                        div.style.fontFamily = state.computedStyle.fontFamily;
                        div.style.fontSize = state.computedStyle.fontSize;
                        div.style.lineHeight = state.computedStyle.lineHeight;
                        div.style.color = state.computedStyle.color;
                        div.style.padding = '0'; // å»é™¤å¤šä½™ paddingï¼Œå› ä¸º wrapper å·²ç»æœ‰äº†

                        // 4. å¡«å…¥çœŸå®å†…å®¹
                        // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œç»™ä¸ªç©ºæ ¼å ä½ï¼Œé˜²æ­¢é«˜åº¦å¡Œé™·
                        div.innerText = state.value || ' ';

                        // 5. æ›¿æ¢
                        if (clonedTextarea.parentNode) {
                            clonedTextarea.parentNode.replaceChild(div, clonedTextarea);
                        }
                    });

                    // éšè—åº•éƒ¨çš„æŒ‰é’®æ ï¼Œæˆªå›¾æ›´å¥½çœ‹
                    const controls = clonedDoc.querySelector('.global-row-controls');
                    if (controls) controls.style.display = 'none';

                    // éšè—èœå•
                    const menu = clonedDoc.querySelector('.dropdown-menu');
                    if (menu) menu.style.display = 'none';
                },

                scrollX: 0,
                scrollY: 0,
                width: fullWidth,
                height: fullHeight,
                windowWidth: fullWidth,
                windowHeight: fullHeight,
                backgroundColor: "#f4f7f9",
                scale: 2 // æé«˜æ¸…æ™°åº¦ (2å€å›¾)
            }).then(canvas => {
                downloadFile(canvas.toDataURL("image/png"), `TRPG_Replay_${getTimeStr()}.png`);
                btn.innerText = originalText;
            }).catch(err => {
                console.error("æˆªå›¾å¤±è´¥:", err);
                alert("æˆªå›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
                btn.innerText = originalText;
            });
        }

        // --- 2. å¯¼å‡ºå‰§æœ¬ (.txt) - æ ¸å¿ƒé€»è¾‘ä¿®æ­£ç‰ˆ ---
        function exportTxt() {
            closeMenu();

            // A. é¢„å¤„ç†ï¼šè®¡ç®—æ¯ä¸ªæ ¼å­çš„è¡Œå·å’Œåˆ—ä¿¡æ¯
            // å¿…é¡»ä¸¥æ ¼å¤åˆ» renderBox çš„è®¡æ•°é€»è¾‘ï¼Œå¦åˆ™è¡Œå·ä¼šå¯¹ä¸ä¸Š
            let boxPositionMap = []; // { rowIndex, colId, content }
            let tempColCounts = {};
            currentColumns.forEach(c => tempColCounts[c.id] = 0);

            // æ³¨æ„ï¼šä¾èµ– currentBoxes çš„é¡ºåºï¼Œå‡è®¾åç«¯æŒ‰æ’å…¥/IDé¡ºåºè¿”å›
            currentBoxes.forEach(b => {
                tempColCounts[b.columnId] = (tempColCounts[b.columnId] || 0) + 1;
                boxPositionMap.push({
                    rowIndex: tempColCounts[b.columnId],
                    colId: b.columnId,
                    content: b.content
                });
            });

            // è·å–æ€»è¡Œæ•°
            let maxRow = 0;
            Object.values(tempColCounts).forEach(c => { if (c > maxRow) maxRow = c; });

            let txt = `=== TRPG è·‘å›¢è®°å½• ===\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n`;

            // B. éå†å›åˆï¼šæ­¥é•¿ä¸º 2 (Line 1 & 2 = Round 1)
            for (let r = 1; r <= maxRow; r += 2) {
                let roundNum = (r + 1) / 2;
                let hasContent = false;
                let roundTxt = `--- ç¬¬ ${roundNum} å›åˆ ---\n\n`;

                // --- å¥‡æ•°è¡Œ (r)ï¼šå®ˆç§˜äºº ---
                // æ‰¾å‡ºè¿™ä¸€è¡Œæ‰€æœ‰æœ‰å­—çš„æ ¼å­ï¼Œæ‹¼æ¥èµ·æ¥
                let kpTexts = boxPositionMap
                    .filter(b => b.rowIndex === r && b.content && b.content.trim())
                    .map(b => b.content.trim());

                if (kpTexts.length > 0) {
                    roundTxt += `ã€å®ˆç§˜äººã€‘:\n${kpTexts.join("\n")}\n\n`;
                    hasContent = true;
                }

                // --- å¶æ•°è¡Œ (r+1)ï¼šè°ƒæŸ¥å‘˜ ---
                let plRowIndex = r + 1;
                // æŒ‰åˆ—çš„é¡ºåºéå†ï¼Œè¿™æ ·å¯¹è¯é¡ºåºä¹Ÿæ˜¯ä»å·¦åˆ°å³
                currentColumns.forEach(col => {
                    let box = boxPositionMap.find(b => b.rowIndex === plRowIndex && b.colId === col.id);
                    if (box && box.content && box.content.trim()) {
                        roundTxt += `ã€${col.title}ã€‘:\n${box.content.trim()}\n\n`;
                        hasContent = true;
                    }
                });

                if (hasContent) {
                    txt += roundTxt;
                }
            }

            // C. ä¸‹è½½
            const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            downloadFile(url, `TRPG_Novel_${getTimeStr()}.txt`);
        }

        // --- 3. å¯¼å‡ºå¤‡ä»½ (.json) ---
        function exportJson() {
            closeMenu();
            const data = {
                version: "1.4.1",
                timestamp: new Date().toISOString(),
                columns: currentColumns,
                boxes: currentBoxes
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            downloadFile(url, `TRPG_Data_${getTimeStr()}.json`);
        }

        // --- è¾…åŠ©å·¥å…· ---
        function getTimeStr() {
            return new Date().toISOString().slice(0, 19).replace(/[-T:]/g, "");
        }

        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- SignalR ä¸æ¸²æŸ“é€»è¾‘ ---
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/workspaceHub")
            .withAutomaticReconnect()
            .build();

        let currentColumns = [];
        let currentBoxes = []; // å…¨å±€ä¿å­˜æ•°æ®
        let columnCounts = {};
        let renderedRows = new Set();

        function toggleMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('moreMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function closeMenu(e) {
            if (e) e.stopPropagation();
            document.getElementById('moreMenu').style.display = 'none';
        }

        connection.on("LoadWorkspace", (columns, boxes) => {
            currentColumns = columns;
            currentBoxes = boxes; // ä¿å­˜æ•°æ®

            const grid = document.getElementById("main-grid");
            const nav = document.querySelector('.top-nav');
            const menuContainer = document.querySelector('.menu-container');

            grid.innerHTML = "";
            columnCounts = {};
            renderedRows.clear();

            document.documentElement.style.setProperty('--grid-layout', `repeat(${columns.length}, minmax(280px, 1fr)) 50px`);

            nav.querySelectorAll('.nav-item').forEach(el => el.remove());
            columns.forEach(col => {
                columnCounts[col.id] = 0;
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.innerHTML = `<input type="text" class="column-title-input" id="title-${col.id}" value="${col.title}" oninput="onTitleChange('${col.id}')">`;
                nav.insertBefore(item, menuContainer);
            });

            boxes.forEach(b => {
                const colIndex = columns.findIndex(c => c.id === b.columnId) + 1;
                if (colIndex > 0) renderBox(b.columnId, b.id, b.content, colIndex);
            });

            renderGlobalButton();
        });

        function renderGlobalButton() {
            const grid = document.getElementById("main-grid");
            const container = document.createElement("div");
            container.className = "global-row-controls";
            const btn = document.createElement("button");
            btn.className = "add-row-btn";
            btn.onclick = askAddRow;
            btn.innerHTML = "<span>+</span> æ‰¹é‡æ·»åŠ  10 è¡Œå‰§æƒ… (åŒæ­¥æ‰€æœ‰åˆ—)";
            container.appendChild(btn);
            grid.appendChild(container);
        }

        function renderBox(columnId, boxId, content, colIndex) {
            const grid = document.getElementById("main-grid");
            columnCounts[columnId]++;
            const rowIndex = columnCounts[columnId];

            updateRowLabel(rowIndex);

            const wrapper = document.createElement("div");
            wrapper.className = `box-wrapper ${rowIndex % 2 !== 0 ? 'row-odd' : 'row-even'}`;
            wrapper.style.gridColumn = colIndex;
            wrapper.style.gridRow = rowIndex;

            const textarea = document.createElement("textarea");
            textarea.id = boxId;
            textarea.value = content;
            textarea.placeholder = "...";
            textarea.oninput = function () { autoResize(this); onTyping(boxId); };

            wrapper.appendChild(textarea);
            grid.appendChild(wrapper);

            autoResize(textarea);
        }

        function updateRowLabel(rowIndex) {
            if (renderedRows.has(rowIndex)) return;

            const labelId = "label-row-" + rowIndex;
            const label = document.createElement("div");
            label.id = labelId;
            const isKeeper = rowIndex % 2 !== 0;
            label.className = `row-label ${isKeeper ? 'label-keeper' : 'label-investigator'}`;
            label.innerText = isKeeper ? "å®ˆç§˜äºº" : "è°ƒæŸ¥å‘˜";
            label.style.gridRow = rowIndex;
            document.getElementById("main-grid").appendChild(label);

            renderedRows.add(rowIndex);
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function askAddColumn() {
            // æµè§ˆå™¨åŸç”Ÿå¼¹çª—
            let p = prompt("ğŸ”‘ è¯·è¾“å…¥ç®¡ç†å¯†ç ä»¥ [æ·»åŠ åˆ—]ï¼š");
            if (p === null) return; // å–æ¶ˆ
            if (p === "0721") {
                connection.invoke("AddColumn");
            } else {
                alert("ğŸš« å¯†ç é”™è¯¯ï¼");
            }
        }

        function askRemoveColumn() {
            let p = prompt("ğŸ”‘ è¯·è¾“å…¥ç®¡ç†å¯†ç ä»¥ [åˆ é™¤åˆ—]ï¼š");
            if (p === null) return;
            if (p === "0721") {
                if (confirm("âš ï¸ ç¡®å®šè¦åˆ é™¤æœ€åä¸€åˆ—å—ï¼Ÿè¯¥åˆ—æ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼")) {
                    connection.invoke("RemoveLastColumn");
                }
            } else {
                alert("ğŸš« å¯†ç é”™è¯¯ï¼");
            }
        }
        function askAddRow() { connection.invoke("RequestAddRow").catch(err => console.error(err)); }
        function onTyping(boxId) {
            const val = document.getElementById(boxId).value;
            connection.invoke("SendTextUpdate", boxId, val);
        }
        function onTitleChange(columnId) {
            const val = document.getElementById("title-" + columnId).value;
            connection.invoke("UpdateColumnTitle", columnId, val);
        }

        connection.on("OnLayoutUpdated", () => location.reload());
        connection.on("OnTextUpdated", (boxId, content) => {
            const el = document.getElementById(boxId);
            if (el) { el.value = content; autoResize(el); }
        });
        connection.on("OnTitleUpdated", (columnId, newTitle) => {
            const input = document.getElementById("title-" + columnId);
            if (input) input.value = newTitle;
        });

        connection.start().catch(err => console.error(err));
    </script>
</body>
</html>